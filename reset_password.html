<?php
// Database Connection
$servername = "localhost";
$username = "root";  // Change as needed
$password = "";  // Change as needed
$dbname = "user_auth";

$conn = new mysqli($servername, $username, $password, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

session_start();

$message = ""; // Message placeholder

// Reset Password
if (isset($_POST['reset_password'])) {
    if (!isset($_SESSION['reset_email']) || !isset($_SESSION['reset_allowed'])) {
        $message = "Unauthorized access.";
    } else {
        $email = $_SESSION['reset_email'];
        $new_password = password_hash(trim($_POST['new_password']), PASSWORD_BCRYPT);
        
        $stmt = $conn->prepare("UPDATE users SET password = ? WHERE email = ?");
        $stmt->bind_param("ss", $new_password, $email);
        
        if ($stmt->execute()) {
            $message = "Password reset successful. Redirecting to login page";
            session_destroy(); // Clear session after password reset
            echo "<script>
                    setTimeout(function(){ window.location.href = 'login.html'; }, 3000);
                  </script>";
        } else {
            $message = "Error updating password. Please try again.";
        }
        
        $stmt->close();
    }
}

$conn->close();
?>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log In</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="icon.png">
</head>

<body>
  <div class="maincontent">
    <div class="header log">
      <div class="header1"><img class="logo" src="logo.png" alt=""></div>
      <!-- <div class="header2">
                <div class="link"><a href="home.html">Home</a></div>
                <div class="link"><a href="datastream.html">Data Stream</a></div>
                <div class="link"><a href="aboutus.html">About Us</a></div>
                <div class="link"><a href="contactus.html">Contact Us</a></div>
            </div> -->
      <div class="header3">
        <!-- <p>Don't have an account?</p>
                <a href="signup.html"><button>Sign Up</button></a> -->
      </div>
      <!-- <div class="container">
              <div class="burger-menu"><ion-icon name="menu-sharp"></ion-icon></div>
              <nav id="nav-menu">
                  <a href="home.html">Home</a>
                  <a href="datastream.html">DataStream</a>
                  <a href="aboutus.html">About Us</a>
                  <a href="contactus.html">Contact Us</a>
              </nav>
          </div> -->
    </div>


    <form method="post">
      <div class="form">
        <div class="tag">
          <h2>
            <center>Reset Password</center>
          </h2>
        </div>
        <div class="inputs">
          <input style="width: 300px; padding: 7px; outline: none;" type="password" name="new_password"
            placeholder="New Password" required />
        </div>
        <center><p style="color: grey;"> <?php echo $message; ?> </p></center>

        <div class="login">
          <button type="submit" name="reset_password">Reset Password</button>
          </p>
        </div>
      </div>
    </form>
    <!-- <div class="google">
      <div class="img"><ion-icon name="logo-google"></ion-icon></div>
      <div class="text" style="font-size: 15px;">Sign in with Google</div>
    </div><br><br> -->

  </div>


  <script>
    const burgerMenu = document.querySelector('.burger-menu');
    const navMenu = document.getElementById('nav-menu');

    burgerMenu.addEventListener('click', () => {
      navMenu.style.display = navMenu.style.display === 'block' ? 'none' : 'block';
    });
  </script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>
